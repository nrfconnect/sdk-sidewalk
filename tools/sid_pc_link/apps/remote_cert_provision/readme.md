# Sidewalk Remote Service Provisioning Script

This script provisions a 1P/3P device from a PC with credentials using Sidewalk Remote Certificate
Provisioning otherwise known as SRCP. SRCP is used to deploy Sidewalk certificates to production
devices in the field, and requires specific infrastructure to be built by a 3P.

Normally Sidewalk devices would be provisioned at a factory, or flashed with a Sidewalk manufacturing
store generated by the the provision.py tool in the MCU SDK.

This script is provided for demonstration purposes and emulates the behavior of SRCP using a
reference firmware application called sid_rcp on the Nordic nRF52840-DK.

At the end of the SRCP procedure the device will store Sidewalk credentials in an updated manufacturing
store on the device.

The device can then be registered on the Sidewalk network by flashing the appropriate application, for
example sid_ble.

# Pre-requisites

PC setup:
- Python 3 or greater
- Ubuntu 18.04

Build the sid_rcp firmware application from the MCU SDK and flash it onto Nordic nRF52840-DK.

Install Python 3 pre-requisites:
```
python3 -m pip install -r requirements.txt
```

# Generate an LWA token
See LWA Token in `sid_pc_link/apps/device_registration/readme.md`.
```
./main.py --lwa --client-id ${CLIENT-ID}

```

This displays a web page with a LWA token to be added to the app_config.json file. Note the prefix
string `Bearer` needs to be added to the token string from the webpage.

```
 "LWA_TOKEN": "Bearer Atza|IwEBIIeBeFjPXwKVvbwgq_QyokXCx-OrlRaiUOJ9czXBvpfc_I61E10Wu7O2AImNV2eXOi6yuG7yOJ5dmtxuzshHwqHnw5XeCdD1ZHELXI0kDPM4iK4MJmV1k4TsEtqz2kBhdl9_40wB3bq13_wou_VZTwoxTsZ6NxbZ67e447yShMS3WWcZ9JSr3A9mfLTR6c-y__MPfzUV6EAgyEWxhoo4B-H9q52NmP0eqsEe59EXQ9d6gMHC3UrySdpDo8i21es6dP4dZWW8MSUoiLAXtyChHvY-m94X1f9TNZZs1RcNWZhvsPkyNgSnAaHAGuKwIjfxMO8yyz57WS8bU2RobBpo_fomWflay_6X7Zh8MP6bMPZqU3Ir3-zXRxAq7chPpQiq1SsizvJ4qDl5nyKsACGCERzFqpOhH-neKVzm5kU3oPhbXA",
```

# Edit app_config.json

Navigate to `sid_pc_link/apps/remote_cert_provision`.

## Example app_config.json files with LWA Token
```
Example of app_config.json:
{
  "REGISTRATION_ENVIRONMENT": "gamma",
  "BLUETOOTH_ADAPTER": "hci1",
  "COMMAND_TIMEOUT": 2,
  "DEVICE_IDENTIFIER": "F1:C7:B9:69:49:93",
  "GATEWAY_ID": null,
  "AUTH_TOKEN": null,
  "LWA_TOKEN": "Bearer Atza|IwEBIIeBeFjPXwKVvbwgq_QyokXCx-OrlRaiUOJ9czXBvpfc_I61E10Wu7O2AImNV2eXOi6yuG7yOJ5dmtxuzshHwqHnw5XeCdD1ZHELXI0kDPM4iK4MJmV1k4TsEtqz2kBhdl9_40wB3bq13_wou_VZTwoxTsZ6NxbZ67e447yShMS3WWcZ9JSr3A9mfLTR6c-y__MPfzUV6EAgyEWxhoo4B-H9q52NmP0eqsEe59EXQ9d6gMHC3UrySdpDo8i21es6dP4dZWW8MSUoiLAXtyChHvY-m94X1f9TNZZs1RcNWZhvsPkyNgSnAaHAGuKwIjfxMO8yyz57WS8bU2RobBpo_fomWflay_6X7Zh8MP6bMPZqU3Ir3-zXRxAq7chPpQiq1SsizvJ4qDl5nyKsACGCERzFqpOhH-neKVzm5kU3oPhbXA",
}

BLUETOOTH_ADAPTER : Run hcitool devices to get the adapter information
DEVICE_IDENTIFIER : Run sudo hcitool lescan to get the device Bluetooth MAC address
LWA_TOKEN : LWA token
```

# Run remote_cert_provision script

Navigate to `sid_pc_link/apps/remote_cert_provision`

```
./main.py
```

This generate a bunch of logs, but if the procedure is succcessful you should see a log like:

```
INFO DEVICE Successfully remote service provisioned with SMSN: 8DF7CC78D2C76450D0C75BFA314BDFCE1216D2626130D49E49D1556D1A27A9AB
```

*NOTE*: Make a note of the SMSN value, this will be needed as the ENDPOINT_ID value when registering the device on the Sidewalk network using the sid_pc_link/apps/device_registration script.

# Appendix

## Description of the app_config.json file entries
| Entry                    | Description                                                                                                                                                      | Default value | Possible value        | Comments                                                             |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------|-----------------------|----------------------------------------------------------------------|
| REGISTRATION_ENVIRONMENT | Cloud environment. Defines endpoint to register the device                                                                                                       | beta          | beta<br>gamma<br>prod |                                                                      |
| BLUETOOTH_ADAPTER        | Name of the Bluetooth adapter to use in the registration process                                                                                                 | hci0          | hci0<br>hci1          | Run hcitool devices to get the adapter information                   |
| COMMAND_TIMEOUT          | Time in seconds to wait for a response from selected edge device                                                                                                 | 2             | Any value             |                                                                      |
| DEVICE_IDENTIFIER        | Bluetooth MAC address of the selected edge device to register                                                                                                          | -             | -                     | Run sudo hcitool lescan to get the device Bluetooth MAC address             |
| GATEWAY_ID               | Sidewalk ID of the Gateway device that will be used in the registration process                                                                                  | -             | -                     | Only required when Z-ASSET token is used                             |
| AUTH_TOKEN               | z-asset to authenticate calls to cloud endpoints                                                                                                                 | -             | -                     | Should be obtained from gateway registered to the account            |
| LWA_TOKEN                | LWA token to authenticate calls to cloud endpoints                                                                                                               | -             | -                     | Retrieved from following steps under "Steps using LWA Token" section |

## Steps using Z-asset token

### Steps for execution:

- Navigate to: `sid_pc_link/apps/remote_cert_provision`
  + Modify `app_config.json` file
- Navigate to: `sid_pc_link/apps/remote_cert_provision`
  + RUN `./main.py`


### Sample run using Z-asset token and Gateway ID

- `cd path/to/sid_pc_link/apps/remote_cert_provision`
- Run `./main.py`

#### Example app_config.json files with z-asset Token
```
app_config.json
{
  "REGISTRATION_ENVIRONMENT": "gamma",
  "BLUETOOTH_ADAPTER": "hci1",
  "COMMAND_TIMEOUT": 2,
  "DEVICE_IDENTIFIER": "F1:C7:B9:69:49:93",
  "GATEWAY_ID": "A0002C5CC0",
  "ENDPOINT_ID": "3E3069414973133E681C7AB5145B6C539C1E7401B99FBA8FA7D148D9EC73BF33",
  "AUTH_TOKEN": "z-asset MjkwNzMyODo5MmE5YWJlMC05NjA5LTQxODYtNWExMi1lMjNiYzc2MmM2M2Y=",
  "LWA_TOKEN": null,
}

BLUETOOTH_ADAPTER : Run hcitool devices to get the adapter information
DEVICE_IDENTIFIER : Run sudo hcitool lescan to get Nordic-DK BLE mac address
GATEWAY_ID : Registered gateway id with the account
AUTH_TOKEN : z-asset token
```
